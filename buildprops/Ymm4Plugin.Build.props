<Project>
  <!-- ymm4 plugin build settings -->
  <!--
    プラグインのプロジェクトから以下のように読んでください
    <Import Project="path/to/buildprops/Ymm4Plugin.Build.props" />
  -->
  <!-- See https://aka.ms/dotnet/msbuild/customize for more details on customizing your build -->
  <PropertyGroup>
    <UseWPF>true</UseWPF>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <NoWarn>$(NoWarn);MSB3277</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <!-- README -->
    <Content Include="../../README.md">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
    </Content>
    <Content Include="../../LICENSE">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
    </Content>
    <Content Include="../../licenses/**" LinkBase="licenses/" Exclude="**/.gitkeep">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
    </Content>
    <!-- exclude -->
    <ExcludeFromPublish Include="**\*.pdb" />
    <ExcludeFromPublish Include="**\*.xml" />
    <ExcludeFromPublish Include="**\*.log" />
    <!-- YMM4 plugins -->
    <Reference Include="$(YMM4_PATH)\YukkuriMovieMaker.Plugin.dll">
      <Private>false</Private>
      <CopyLocal>false</CopyLocal>
    </Reference>
    <Reference Include="$(YMM4_PATH)\YukkuriMovieMaker.Controls.dll">
      <Private>false</Private>
      <CopyLocal>false</CopyLocal>
    </Reference>
  </ItemGroup>

  <!-- MS Build settings -->

  <Target Name="RemovePublishDirBeforeBuild" BeforeTargets="BeforeBuild">
    <RemoveDir Directories="$(YMM4_PATH)\user\plugin\$(AssemblyName)\" />
    <Message Text="RemovePublishDirBeforeBuild" Importance="high" />
  </Target>
  <Target Name="CopyDebugDlls" AfterTargets="Build" Condition="'$(Configuration)' == 'Debug'">
    <!-- デバッグ出力を追加 -->
    <Message Text="=== CopyDebugDlls is RUNNING ===" Importance="high" />
    <Message Text="OutputPath: $(OutputPath)" Importance="high" />
    <Message Text="YMM4_PATH: $(YMM4_PATH)" Importance="high" />
    <Message Text="AssemblyName: $(AssemblyName)" Importance="high" />

    <!-- 環境変数チェック -->
    <Error Text="YMM4_PATH environment variable is not set!" Condition="'$(YMM4_PATH)' == ''" />

    <ItemGroup>
      <CommonPaths Include="$(OutputPath)" />
      <MissingDlls Include="$(OutputPath)*.dll" Exclude="$(OutputPath)$(AssemblyName).dll" />
      <MissingPdbs Include="$(OutputPath)*.pdb" Exclude="$(OutputPath)$(AssemblyName).pdb" />
    </ItemGroup>

    <!-- コピー先ディレクトリの作成 -->
    <MakeDir Directories="$(YMM4_PATH)\user\plugin\$(AssemblyName)" />

    <ItemGroup>
      <SourceFiles Include="$(OutputPath)**/*.*" />
    </ItemGroup>

    <Copy SourceFiles="@(SourceFiles)" DestinationFiles="@(SourceFiles->'$(YMM4_PATH)\user\plugin\$(AssemblyName)\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Message Text="Dlls @(MissingDlls)" Importance="high" />
    <Message Text="PDBs @(MissingPdbs)" Importance="high" />
    <Message Text="★Copy completed to: $(YMM4_PATH)\user\plugin\$(AssemblyName)" Importance="high" />
  </Target>
  <Target Name="CleanBeforePublish" BeforeTargets="BeforePublish">
    <RemoveDir Directories="$(OutputPath)/publish/" />
    <RemoveDir Directories="$(OutputPath)/ymme/" />
  </Target>
  <Target Name="MakeZipPackage" AfterTargets="Publish">
    <PropertyGroup>
      <ZipFileName>$(AssemblyName).v.$(Version).ymme</ZipFileName>
      <!-- 正しいパスに修正 -->
      <PublishRootDir>$(MSBuildProjectDirectory)\..\..\publish\</PublishRootDir>
      <ZipDestination>$(PublishRootDir)$(ZipFileName)</ZipDestination>
      <PackageFolder>$(OutputPath)/ymme/$(AssemblyName)</PackageFolder>
      <ZipSource>$(OutputPath)/ymme</ZipSource>
    </PropertyGroup>

    <!-- デバッグ出力を追加 -->
    <Message Text="PublishRootDir: $(PublishRootDir)" Importance="high" />
    <Message Text="PackageFolder: $(PackageFolder)" Importance="high" />
    <Message Text="ZipSource: $(ZipSource)" Importance="high" />
    <Message Text="ZipDestination: $(ZipDestination)" Importance="high" />

    <!-- ディレクトリを作成 -->
    <MakeDir Directories="$(PublishRootDir)" />
    <MakeDir Directories="$(PackageFolder)" />

    <ItemGroup>
      <!-- 既存の削除対象ファイル -->
      <FilesToDelete Include="$(OutputPath)\publish\Vortice.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\NCalc.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Newtonsoft.Json.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Microsoft.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\MathNet.Numerics.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\WinRT.Runtime.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Parlot.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\ExtendedNumerics.BigDecimal.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\SharpGen.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\System.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\ICSharpCode.AvalonEdit.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\runtimes\win\lib\**\System.Management.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\YukkuriMovieMaker.*.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\YukkuriMovieMaker.*.pdb" />

      <!-- 追加: PDBファイルの削除 -->
      <FilesToDelete Include="$(OutputPath)\publish\*.pdb" />

      <!-- 追加: ILRepackでマージされたDLLの削除 (メインDLL以外) -->
      <FilesToDelete Include="$(OutputPath)\publish\YmmeUtil.Bridge.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\YmmeUtil.Ymm4.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\YmmeUtil.Common.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Epoxy.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Epoxy.Core.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Epoxy.Wpf.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Dynamitey.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\ImpromptuInterface.dll" />

      <!-- YmmeUtilの依存関係も削除 -->
      <FilesToDelete Include="$(OutputPath)\publish\BigHelp.Http.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\ByteSize.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\GithubReleaseDownloader.dll" />
      <FilesToDelete Include="$(OutputPath)\publish\Mayerch1.GithubUpdateCheck.dll" />

      <FilesToDelete Include="$(OutputPath)\publish\*.deps.json" />
    </ItemGroup>
    <Delete Files="@(FilesToDelete)">
      <Output TaskParameter="DeletedFiles" ItemName="FilesDeleted" />
    </Delete>

    <ItemGroup>
      <PublishFiles Include="$(OutputPath)/publish/**/*.*" />
    </ItemGroup>

    <!-- ファイルをコピー -->
    <Copy
      SourceFiles="@(PublishFiles)"
      DestinationFiles="@(PublishFiles->'$(PackageFolder)/%(RecursiveDir)%(Filename)%(Extension)')" />

    <!-- ZipSourceディレクトリの存在確認 -->
    <Error Text="ZipSource directory does not exist: $(ZipSource)" Condition="!Exists('$(ZipSource)')" />

    <!-- Zip圧縮 -->
    <ZipDirectory
      SourceDirectory="$(ZipSource)"
      DestinationFile="$(ZipDestination)"
      Overwrite="true" />

    <Message Text="Zip package created at: $(ZipDestination)" Importance="high" />

    <Unzip SourceFiles="$(ZipDestination)" DestinationFolder="$(YMM4_PATH)\user\plugin\$(AssemblyName)\" />
  </Target>
  <!-- Release構成でも直接コピーできるようにする -->
  <Target Name="CopyReleaseDlls" AfterTargets="Publish" Condition="'$(Configuration)' == 'Release'">
    <Warning Text="=== CopyReleaseDlls is RUNNING ===" />

    <ItemGroup>
      <PublishFiles Include="$(OutputPath)/publish/**/*.*" />
    </ItemGroup>

    <Copy
      SourceFiles="@(PublishFiles)"
      DestinationFiles="@(PublishFiles->'$(YMM4_PATH)\user\plugin\$(AssemblyName)\%(RecursiveDir)%(Filename)%(Extension)')" />

    <Warning Text="Files copied directly to YMM4 plugin folder" />
  </Target>
</Project>
